# .github/workflows/mobile-ci.production.yml
name: (Production) Mobile Web CI

on:
  workflow_call:
    inputs:
      image_tag:
        required: true
        type: string
    secrets:
      DOCKER_USERNAME:
        required: true
      DOCKER_TOKEN:
        required: true

jobs:
  lint:
    name: Lint mobile
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v3
        with:
          node-version: '20'
      - run: npm install -g pnpm
      - run: pnpm install --frozen-lockfile
      - run: pnpm nx lint mobile --max-warnings=0 || true

  build:
    name: Build & Push clara-client
    runs-on: self-hosted
    needs: lint
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v3
        with:
          node-version: '20'
      - run: npm install -g pnpm
      - run: pnpm install --frozen-lockfile
      - name: Export Expo web bundle
        env:
          EXPO_NO_TELEMETRY: 1
          EXPO_USE_WATCHMAN: 0
        run: pnpm nx run mobile:build:web
      - name: Flatten vector-icon fonts (avoid __node_modules paths)
        run: node apps/mobile/_tools/flatten-vector-icons.mjs apps/mobile/dist apps/mobile/dist/fonts
      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}
      - name: Docker build & push (clara-client)
        run: |
          TAG=${{ inputs.image_tag }}
          docker build --platform linux/arm64 \
            -f docker/clara-client/Dockerfile.prod \
            -t eliasdb/clara-client:$TAG .
          docker push eliasdb/clara-client:$TAG
