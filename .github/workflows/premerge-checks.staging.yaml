name: Pre-Merge Checks Staging

on:
    pull_request:
        branches:
            - dev

jobs:
    setup:
        name: Setup Environment
        runs-on: [self-hosted]
        outputs:
            image_tag: ${{ steps.version.outputs.image_tag }}
        steps:
            - name: Checkout Code
              uses: actions/checkout@v3
              with:
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: '20'

            - name: Clear Corepack Cache & Install pnpm
              run: |
                  corepack disable
                  rm -rf ~/.cache/corepack
                  corepack enable
                  corepack prepare pnpm@latest --activate

            - name: Install Dependencies
              run: pnpm install

            - name: Set Version with PR Number
              id: version
              run: |
                  PR_NUMBER=${{ github.event.pull_request.number }}
                  VERSION=pr-${PR_NUMBER}-staging
                  echo "image_tag=${VERSION}" >> $GITHUB_ENV
                  echo "image_tag=${VERSION}" >> $GITHUB_OUTPUT

    lint:
        name: Lint Affected Projects
        runs-on: [self-hosted]
        needs: setup
        steps:
            - name: Checkout Code
              uses: actions/checkout@v3
            - name: Setup Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: '20'

            - name: Install pnpm
              run: corepack enable && corepack prepare pnpm@latest --activate

            - name: Install Dependencies
              run: pnpm install

            - name: Lint Affected Projects
              run: pnpm nx affected --target=lint --base=origin/dev --head=HEAD --parallel --verbose

    test:
        name: Test Affected Projects
        runs-on: [self-hosted]
        needs: lint
        steps:
            - name: Checkout Code
              uses: actions/checkout@v3
            - name: Setup Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: '20'

            - name: Install pnpm
              run: corepack enable && corepack prepare pnpm@latest --activate

            - name: Install Dependencies
              run: pnpm install

            - name: Test Affected Projects
              run: pnpm nx affected --target=test --base=origin/dev --head=HEAD --parallel --verbose

    build:
        name: Build Docker Images for Affected Projects
        runs-on: [self-hosted]
        needs: [test, setup]
        steps:
            - name: Checkout Code
              uses: actions/checkout@v3

            - name: Setup Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: '20'

            - name: Install pnpm
              run: corepack enable && corepack prepare pnpm@latest --activate

            - name: Install Dependencies
              run: pnpm install

            - name: Log in to Docker Hub
              uses: docker/login-action@v2
              with:
                  username: ${{ secrets.DOCKER_USERNAME }}
                  password: ${{ secrets.DOCKER_TOKEN }}

            - name: Build and Push Docker Images for Affected Projects
              run: |
                  AFFECTED_APPS=$(pnpm nx show projects --affected --type=app --base=origin/dev --head=HEAD --plain)
                  for app in $AFFECTED_APPS; do
                    docker build -f $app/Dockerfile.staging -t eliasdb/$app:${{ needs.setup.outputs.image_tag }} .
                    # docker push eliasdb/$app:${{ needs.setup.outputs.image_tag }}
                  done
