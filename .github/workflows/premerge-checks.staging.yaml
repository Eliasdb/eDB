name: Pre-Merge Checks Staging

on:
    pull_request:
        branches:
            - dev
    # workflow_dispatch: # Enable manual trigger
    #     inputs:
    #         job_to_run:
    #             description: 'Select the job to run'
    #             required: false
    #             default: 'all'
    #             type: choice
    #             options:
    #                 - all
    #                 - lint
    #                 - test
    #                 - build

jobs:
    version:
        name: Set Version
        runs-on: self-hosted
        outputs:
            image_tag: ${{ steps.version.outputs.image_tag }}
        steps:
            - name: Set Version with PR Number
              id: version
              run: |
                  PR_NUMBER=${{ github.event.pull_request.number }}
                  VERSION=pr-${PR_NUMBER}-staging
                  echo "image_tag=${VERSION}" >> $GITHUB_ENV
                  echo "image_tag=${VERSION}" >> $GITHUB_OUTPUT

    lint:
        name: Lint Affected Projects
        runs-on: self-hosted
        needs: version
        steps:
            - name: Checkout Code
              uses: actions/checkout@v3

            - name: Setup Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: '20'

            - name: Install .NET SDK
              uses: actions/setup-dotnet@v3
              with:
                  dotnet-version: '8.0'

            - name: Install pnpm
              run: npm install -g pnpm --force

            - name: Install Dependencies
              run: pnpm install
              working-directory: ./eDB

            - name: Lint Affected Projects
              run: pnpm nx affected --target=lint --base=origin/dev --head=HEAD --parallel || true
              working-directory: ./eDB

    test:
        name: Test Affected Projects
        runs-on: self-hosted
        needs: [version, lint]
        steps:
            - name: Checkout Code
              uses: actions/checkout@v3

            - name: Setup Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: '20'

            - name: Install .NET SDK
              uses: actions/setup-dotnet@v3
              with:
                  dotnet-version: '8.0'

            - name: Install pnpm
              run: npm install -g pnpm --force

            - name: Install Dependencies
              run: pnpm install
              working-directory: ./eDB

            - name: Test Affected Projects
              run: pnpm nx affected --target=test --base=origin/dev --head=HEAD --parallel || true
              working-directory: ./eDB

    build:
        name: Build Docker Images for Affected Projects
        runs-on: self-hosted
        needs: [version, lint, test]
        steps:
            - name: Checkout Code
              uses: actions/checkout@v3
              with:
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: '20'

            - name: Install .NET SDK
              uses: actions/setup-dotnet@v3
              with:
                  dotnet-version: '8.0'

            - name: Install pnpm
              run: npm install -g pnpm --force

            - name: Install Dependencies
              run: pnpm install
              working-directory: ./eDB

            - name: Log in to Docker Hub
              uses: docker/login-action@v2
              with:
                  username: ${{ secrets.DOCKER_USERNAME }}
                  password: ${{ secrets.DOCKER_TOKEN }}

            - name: Build and Push Docker Images for Affected Projects
              working-directory: ./eDB
              run: |
                  # Get affected apps
                  AFFECTED_APPS=$(pnpm nx show projects --affected --type=app --base=origin/dev --head=HEAD --plain)
                  echo "Affected Apps: $AFFECTED_APPS"

                  # Build eDB-user-account first if affected
                  if echo "$AFFECTED_APPS" | grep -iq "eDB-user-account"; then
                    echo "Building React app eDB-user-account with Vite"
                    pnpm vite build --config apps/eDB-user-account/vite.config.ts
                    pnpm vite build --config apps/eDB-user-account/vite.styles.config.ts
                  fi

                  # Loop through each affected app
                  for app in $AFFECTED_APPS; do
                    echo "üîß Processing app: $app"

                    lower_app=$(echo "$app" | tr '[:upper:]' '[:lower:]')

                    # Skip Docker build for eDB-webshop (part of main app)
                    if [ "$lower_app" = "edb-webshop" ]; then
                      echo "‚ö†Ô∏è Skipping Docker build and push for $app"
                      continue
                    fi

                    # Skip nx build for webshop-api (but keep Docker step)
                    if [ "$lower_app" = "webshop-api" ]; then
                      echo "‚ö†Ô∏è Skipping nx build for $app"
                    elif [ "$app" = "eDB-user-account" ]; then
                      echo "‚ö†Ô∏è Skipping nx build for $app (handled by Vite earlier)"
                    else
                      echo "üèóÔ∏è Building $app with Nx"
                      if [ "$app" = "eDB-admin" ]; then
                        pnpm nx run $app:build --configuration=staging --base-href=/admin/ --deploy-url=/admin/
                      else
                        pnpm nx run $app:build --configuration=staging
                      fi
                    fi

                    # üîç DEBUG: List output directory contents before Docker build
                    if [ "$app" = "eDB" ]; then
                      echo "üìÇ Listing dist/apps/eDB/assets/eDB-user-account:"
                      ls -lh dist/apps/eDB/assets/eDB-user-account || echo "‚ö†Ô∏è Folder missing"
                    fi

                    # Skip Docker build for eDB-user-account (served by Angular)
                    if [ "$app" = "eDB-user-account" ]; then
                      echo "‚ö†Ô∏è Skipping Docker build for $app"
                      continue
                    fi

                    echo "üê≥ Building Docker image for: $lower_app"
                    docker build --platform linux/arm64 -f docker/$app/Dockerfile.staging -t eliasdb/$lower_app:${{ needs.version.outputs.image_tag }} .

                    echo "üöÄ Pushing Docker image: eliasdb/$lower_app:${{ needs.version.outputs.image_tag }}"
                    docker push eliasdb/$lower_app:${{ needs.version.outputs.image_tag }}

                    # üîç DEBUG: Show built Docker context (optional)
                    echo "üì¶ Contents of Docker build context:"
                    find dist/apps/$app | head -n 20
                  done
