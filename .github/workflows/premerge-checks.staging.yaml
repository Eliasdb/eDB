name: (Staging) Pre-Merge Checks

on:
  pull_request:
    branches:
      - dev

jobs:
  # ─────────────────────────────────────────────
  version:
    name: Set Version
    runs-on: self-hosted
    outputs:
      image_tag: ${{ steps.setver.outputs.image_tag }} # SHA
      pretty_tag: ${{ steps.setver.outputs.pretty_tag }} # pr-123-staging (optional)
    steps:
      - name: Set Version (SHA + optional PR tag)
        id: setver
        run: |
          echo "image_tag=${GITHUB_SHA}" >> $GITHUB_OUTPUT
          if [ -n "${{ github.event.pull_request.number }}" ]; then
            echo "pretty_tag=pr-${{ github.event.pull_request.number }}-staging" >> $GITHUB_OUTPUT
          else
            echo "pretty_tag=" >> $GITHUB_OUTPUT
          fi

  # ─────────────────────────────────────────────────────────────────────────────
  # 🔍 Detect Affected Projects for Staging
  # ─────────────────────────────────────────────────────────────────────────────
  detect-affected:
    name: Detect Affected Projects
    runs-on: self-hosted
    needs: version
    outputs:
      admin_changed: ${{ steps.detect.outputs.admin_changed }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0'

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Determine Affected
        id: detect
        run: |
          AFFECTED=$(pnpm nx show projects --affected --plain \
            --base=origin/dev \
            --head=HEAD)

          echo "Affected projects:"
          echo "$AFFECTED"

          ADMIN_CHANGED=$(echo "$AFFECTED" | grep -qw 'mfe-edb-admin' && echo true || echo false)
          echo "admin_changed=$ADMIN_CHANGED" >> $GITHUB_OUTPUT

          echo "Debug:"
          echo "admin_changed=$ADMIN_CHANGED"

  # ─────────────────────────────────────────────
  lint:
    name: Lint Affected Projects
    runs-on: self-hosted
    needs:
      - version
      - detect-affected
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-node@v3
        with:
          node-version: '20'

      - uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0'

      - run: npm install -g pnpm
      - run: pnpm install

      - name: Lint
        run: |
          pnpm nx affected --target=lint \
            --base=origin/dev --head=HEAD \
            --parallel --exclude=mfe-edb-admin || true

  # ─────────────────────────────────────────────
  test:
    name: Test Affected Projects
    runs-on: self-hosted
    needs:
      - version
      - lint
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-node@v3
        with:
          node-version: '20'

      - uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0'

      - run: npm install -g pnpm
      - run: pnpm install

      - name: Test
        run: |
          pnpm nx affected --target=test \
            --base=origin/dev --head=HEAD \
            --parallel --exclude=mfe-edb-admin || true

  # ─────────────────────────────────────────────
  build:
    name: Build & Push Docker Images
    runs-on: self-hosted
    needs:
      - version
      - test
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v3
        with:
          node-version: '20'

      - uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0'

      - run: npm install -g pnpm
      - run: pnpm install

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          export PATH="$HOME/.local/bin:$PATH"
          poetry --version

      - name: Build & Push Docker images (skip admin)
        env:
          SHA_TAG: ${{ needs.version.outputs.image_tag }}
          PRETTY_TAG: ${{ needs.version.outputs.pretty_tag }}
        run: |
          # get all non-admin apps affected
          AFFECTED=$(pnpm nx show projects --affected --type=app \
            --base=origin/dev --head=HEAD --plain --exclude=mfe-edb-admin)

          echo "Affected apps (non-admin): $AFFECTED"

          for app in $AFFECTED; do
            lower_app=$(echo "$app" | tr '[:upper:]' '[:lower:]')

            if [ "$lower_app" != "webshop-api" ] && [ "$app" != "wc-edb-user-account" ] && [ "$app" != "tools-invoices-api" ]; then
              echo "🏗️ Building $app via Nx"
              pnpm nx run "$app":build --configuration=staging
            else
              echo "⚠️ Skipping Nx build for $app"
            fi

            # skip Docker for the user-account app
            if [ "$app" = "wc-edb-user-account" ]; then
              echo "⚠️ Skipping Docker build for $app"
              continue
            fi

            DOCKERFILE="./docker/$lower_app/Dockerfile.staging"
            IMAGE="eliasdb/$lower_app"

            echo "🐳 Building $IMAGE:$SHA_TAG"
            docker build --platform linux/arm64 -f "$DOCKERFILE" -t "$IMAGE:$SHA_TAG" .

            if [ -n "$PRETTY_TAG" ]; then
              echo "🔖 Also tagging $IMAGE:$PRETTY_TAG"
              docker tag "$IMAGE:$SHA_TAG" "$IMAGE:$PRETTY_TAG"
            fi

            echo "🚀 Pushing $IMAGE:$SHA_TAG"
            docker push "$IMAGE:$SHA_TAG"

            if [ -n "$PRETTY_TAG" ]; then
              echo "🚀 Pushing $IMAGE:$PRETTY_TAG"
              docker push "$IMAGE:$PRETTY_TAG"
            fi
          done

  # ─────────────────────────────────────────────
  call-admin:
    name: Admin App CI
    needs:
      - detect-affected
      - version

    if: needs.detect-affected.outputs.admin_changed == 'true'
    uses: ./.github/workflows/admin-ci.staging.yml
    with:
      image_tag: ${{ needs.version.outputs.image_tag }}
    secrets:
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_TOKEN: ${{ secrets.DOCKER_TOKEN }}
